@inject IJSRuntime JsRuntime
@inject MementoMoriFuncs moriFuncs

@page "/"
@using System.Text
@using MementoMori.Ortega.Share
@using MementoMori.Ortega.Share.Data
@using MementoMori.Ortega.Share.Data.ApiInterface.Battle
@using MementoMori.Ortega.Share.Data.ApiInterface.BountyQuest
@using MementoMori.Ortega.Share.Data.ApiInterface.Equipment
@using MementoMori.Ortega.Share.Data.ApiInterface.Friend
@using MementoMori.Ortega.Share.Data.ApiInterface.Gacha
@using MementoMori.Ortega.Share.Data.ApiInterface.Guild
@using MementoMori.Ortega.Share.Data.ApiInterface.GuildRaid
@using MementoMori.Ortega.Share.Data.ApiInterface.TowerBattle
@using MementoMori.Ortega.Share.Enums
@using MementoMori.WebUI.Extensions
@using MementoMori.WebUI.Models
@using StartRequest = MementoMori.Ortega.Share.Data.ApiInterface.TowerBattle.StartRequest
@using StartResponse = MementoMori.Ortega.Share.Data.ApiInterface.TowerBattle.StartResponse

<PageTitle>主页</PageTitle>

<MudGrid>
    <MudItem md="6" lg="4">
        <MudCard>
            <MudCardHeader>
                <MudText>角色信息</MudText>
                <MudButton Disabled="_logining" @onclick="Login">
                    登录
                    @if (_logining)
                    {
                        <MudProgressCircular Size="Size.Small"/>
                    }
                </MudButton>
                <MudButton Disabled="_logining" @onclick="SyncUserData">同步用户信息</MudButton>
            </MudCardHeader>
            <MudCardContent>
                <MudSimpleTable>
                    <tbody>
                    <tr>
                        <td>用户名</td><td>@_userSyncData?.UserStatusDtoInfo?.Name</td>
                    </tr>
                    <tr>
                        <td>玩家ID</td><td>@_userSyncData?.UserStatusDtoInfo?.PlayerId</td>
                    </tr>
                    <tr>
                        <td>友情点</td><td>@_friendPoint</td>
                    </tr>
                    <tr>
                        <td>加入时间</td><td>@_userSyncData?.UserStatusDtoInfo?.CreateAt.ToDateTimeOffset()</td>
                    </tr>
                    <tr>
                        <td>等级</td><td>@_userSyncData?.UserStatusDtoInfo?.Rank</td>
                    </tr>
                    <tr>
                        <td>VIP 等级</td><td>@_userSyncData?.UserStatusDtoInfo?.Vip</td>
                    </tr>
                    <tr>
                        <td>留言</td><td>@_userSyncData?.UserStatusDtoInfo?.Comment</td>
                    </tr>
                    <tr>
                        <td>经验值</td><td>@_userSyncData?.UserStatusDtoInfo?.Exp</td>
                    </tr>
                    <tr>
                        <td>上次登录</td><td>@_userSyncData?.UserStatusDtoInfo?.LastLoginTime.ToDateTimeOffset()</td>
                    </tr>
                    <tr>
                        <td>前次登录</td><td>@_userSyncData?.UserStatusDtoInfo?.PreviousLoginTime.ToDateTimeOffset()</td>
                    </tr>
                    <tr>
                        <td>上次升级</td><td>@_userSyncData?.UserStatusDtoInfo?.LastLvUpTime.ToDateTimeOffset()</td>
                    </tr>
                    <tr>
                        <td>用户名已更改</td><td>@_userSyncData?.UserStatusDtoInfo?.IsAlreadyChangedName</td>
                    </tr>
                    </tbody>
                </MudSimpleTable>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem md="6" lg="8">
        <MudCard>
            <MudCardHeader>快捷操作 <MudButton Disabled="!_isQuickActionExecuting" @onclick="CancelQuickAction">取消操作</MudButton></MudCardHeader>
            <MudCardContent>
                <MudTabs Position="Position.Left">
                    <MudTabPanel Text="一键操作">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="_isQuickActionExecuting" @onclick="GetLoginBonus">领取每日登录奖励</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@GetVipGift">领取每日VIP礼物</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@GetAutoBattleReward">领取自动战斗奖励</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@BulkTransferFriendPoint">一键赠送/接受友情点</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@PresentReceiveItem">一键领取礼物箱</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@BattleBossQuick">主线boss扫荡3次</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@InfiniteTowerQuick">无穷之塔扫荡3次</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@PvpAuto">PVP自动战斗5次</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@BossHishSpeedBattle">冒险一次高速战斗</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@FreeGacha">每日免费一键抽卡</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@GuildCheckin">公会签到</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@GuildRaid">公会讨伐战</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@BountyQuestRewardAuto">祈愿之泉一键领取</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@BountyQuestStartAuto">祈愿之泉一键开始</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@UseFriendCode">邀请码</MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="装备精炼">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@AutoEquipmentInheritance">自动精炼SABC、继承魔装到D装</MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="冒险战斗">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@AutoBossRequest">自动刷Boss</MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="时空洞窟">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@AutoDungeonBattle">时空洞窟自动战斗</MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="无穷之塔">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@AutoInfiniteTowerRequest">自动刷无穷之塔</MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="装备打磨">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@AutoEquipmentTraning">装备打磨</MudButton>
                                <MudSelect T="string" Label="装备ID" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" @bind-Value="_equipmentId">
                                    @foreach (var e in _characterEquipments)
                                    {
                                        <MudSelectItem T="string" Value="e.EquipmentGuid">@($"{e.EquipmentName}/{e.UserEquipmentDtoInfo.ReinforcementLv} {e.CharacterName}")</MudSelectItem>
                                    }
                                </MudSelect>
                                <MudTextField @bind-Value="_equipmentId" Label="装备Id" Variant="Variant.Text"></MudTextField>
                                <MudSelect T="string" @bind-Value="_equipmentTrainingTargetType" Label="类型" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                    <MudSelectItem T="string" Value="@("Health")">耐力</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("Intelligence")">魔力</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("Muscle")">力量</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("Energy")">战技</MudSelectItem>
                                </MudSelect>
                                <MudTextField T="long" @bind-Value="_equipmentTrainingTargetValue" Label="目标值" Variant="Variant.Text"></MudTextField>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="调试">
                        <MudCard>
                            <MudCardContent>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@Debug">Debug</MudButton>
                                <MudButton Variant="Variant.Filled" Disabled="@_isQuickActionExecuting" @onclick="@LogDebug">LogTest</MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                </MudTabs>
            </MudCardContent>
        </MudCard>
        <MudCard>
            <MudCardHeader>执行结果</MudCardHeader>
            <MudCardContent>
                <MudTable T="string" Items="_messsageList" Virtualize="true" Dense="true" Height="400px">
                    <RowTemplate>
                        <MudTd>@context</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="6">
        <MudCard>
            <MudCardContent Style="max-height: 300px; overflow: scroll">
                <pre>
                        @_runtimeInfo.ToJson(true)
                        </pre>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12">
        <MudCard>
            <MudCardContent Style="max-height: 400px; overflow: scroll">
                <pre>
                         @_userSyncData.ToJson(true)
                         </pre>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private RuntimeInfo _runtimeInfo;
    private UserSyncData? _userSyncData;

    private bool _logining;
    private bool _isQuickActionExecuting;
    private long _friendPoint;
    private string _equipmentId;
    private string _equipmentTrainingTargetType;
    private long _equipmentTrainingTargetValue;
    private List<CharacterEquipment> _characterEquipments = new();

    private List<string> _messsageList = new();

    private CancellationTokenSource _cancellationTokenSource;

    protected override async Task OnInitializedAsync()
    {
        moriFuncs.RuntimeInfoSubject.Subscribe(c =>
        {
            InvokeAsync(() =>
            {
                _runtimeInfo = c;
                StateHasChanged();
            });
        });
        moriFuncs.UserSyncData.Subscribe(data =>
        {
            _userSyncData = data;
            _friendPoint = _userSyncData?.UserItemDtoInfo?.FirstOrDefault(d => d.ItemType == ItemType.FriendPoint)?.ItemCount ?? 0;
            _characterEquipments = data?.UserEquipmentDtoInfos?.Where(d => !string.IsNullOrEmpty(d.CharacterGuid)).Select(d =>
            {
                if (d == null) throw new ArgumentNullException(nameof(d));
                var cha = data.UserCharacterDtoInfos.First(x => x.Guid == d.CharacterGuid);
                var chaMb = Masters.CharacterTable.GetById(cha.CharacterId);
                var name = Masters.TextResourceTable.Get(chaMb.NameKey);
                var equipmentMb = Masters.EquipmentTable.GetById(d.EquipmentId);
                var equipmentName = Masters.TextResourceTable.Get(equipmentMb.NameKey);
                equipmentName = $"{equipmentName}/耐力{d.AdditionalParameterHealth}/魔力{d.AdditionalParameterIntelligence}/力量{d.AdditionalParameterMuscle}/战技{d.AdditionalParameterEnergy} ";
                return new CharacterEquipment()
                {
                    CharacterGuid = d.CharacterGuid, CharacterName = name, EquipmentGuid = d.Guid, EquipmentName = equipmentName, UserEquipmentDtoInfo = d
                };
            }).OrderBy(d => d.CharacterGuid).ToList() ?? new List<CharacterEquipment>();
        });
    }


    private async Task Login()
    {
        _logining = true;
        await moriFuncs.AuthLogin();
        var userData = await moriFuncs.UserGetUserData();
        _logining = false;
    }

    private async Task SyncUserData()
    {
        await moriFuncs.UserGetUserData();
    }

    private void AddLog(string message)
    {
        _messsageList.Insert(0, message);
        if (_messsageList.Count > 10000)
        {
            _messsageList.RemoveAt(_messsageList.Count - 1);
        }
        StateHasChanged();
    }
    
    private async Task ExecuteQuickAction(Func<Action<string>,CancellationToken, Task> func)
    {
        _isQuickActionExecuting = true;
        _cancellationTokenSource = new CancellationTokenSource();
        _messsageList.Clear();
        await func(AddLog, _cancellationTokenSource.Token);
        _isQuickActionExecuting = false;
        StateHasChanged();
    }

    private void CancelQuickAction()
    {
        if (_cancellationTokenSource == null) return;
        _cancellationTokenSource.Cancel();
    }

    private async Task GetLoginBonus()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var bonus = await moriFuncs.LoginBonusReceiveDailyLoginBonus(DateTime.Now.Day);
            log("领取的奖励：\n");
            bonus.RewardItemList.PrintUserItems(log);
        });
    }

    private async Task GetVipGift()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var bonus = await moriFuncs.VipGetDailyGift();
            log("领取的奖励：");
            bonus.ItemList.PrintUserItems(log);
        });
    }

    private async Task GetAutoBattleReward()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var bonus = await moriFuncs.BattleRewardAutoBattle();
            log("领取的奖励：");

            log($"战斗次数 {bonus.AutoBattleRewardResult.BattleCountAll}");
            log($"胜利次数 {bonus.AutoBattleRewardResult.BattleCountWin}");
            log($"总时间 {TimeSpan.FromMilliseconds(bonus.AutoBattleRewardResult.BattleTotalTime)}");
            log($"领民金币 {bonus.AutoBattleRewardResult.GoldByPopulation}");
            log($"领民潜能珠宝 {bonus.AutoBattleRewardResult.PotentialJewelByPopulation}");
        });
    }

    private async Task BulkTransferFriendPoint()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var resp = await moriFuncs.FriendBulkTransferFriendPoint();
            log("成功");
        });
    }

    private async Task PresentReceiveItem()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var resp = await moriFuncs.PresentReceiveItem();
            log("领取的奖励：");
            resp.ResultItems.Select(d => d.Item).PrintUserItems(log);
        });
    }

    private async Task BattleBossQuick()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            log("领取的奖励：\n");
            var bossQuickResponse = await moriFuncs.GetResponse<BossQuickRequest, BossQuickResponse>(
                new BossQuickRequest()
                {
                    QuestId = _userSyncData.UserBattleBossDtoInfo.BossClearMaxQuestId,
                    QuickCount = 3
                });
            if (bossQuickResponse.BattleRewardResult == null) return;


            bossQuickResponse.BattleRewardResult.FixedItemList.PrintUserItems(log);
            bossQuickResponse.BattleRewardResult.DropItemList.PrintUserItems(log);
        });
    }

    private async Task InfiniteTowerQuick()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var tower = _userSyncData.UserTowerBattleDtoInfos.First(d => d.TowerType == TowerType.Infinite);
            log("领取的奖励：\n");

            var bossQuickResponse = await moriFuncs.GetResponse<TowerBattleQuickRequest, TowerBattleQuickResponse>(
                new TowerBattleQuickRequest()
                {
                    TargetTowerType = TowerType.Infinite, TowerBattleQuestId = tower.MaxTowerBattleId, QuickCount = 3
                });
            if (bossQuickResponse.BattleRewardResult != null)
            {
                bossQuickResponse.BattleRewardResult.FixedItemList.PrintUserItems(log);
                bossQuickResponse.BattleRewardResult.DropItemList.PrintUserItems(log);
            }
        });
    }

    private async Task PvpAuto()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            log("领取的奖励：\n");
            for (int i = 0; i < 5; i++)
            {
                var pvpInfoResponse = await moriFuncs.GetResponse<GetPvpInfoRequest, GetPvpInfoResponse>(
                    new GetPvpInfoRequest());

                var pvpRankingPlayerInfo = pvpInfoResponse.MatchingRivalList.OrderBy(d => d.DefenseBattlePower).First();

                var pvpStartResponse = await moriFuncs.GetResponse<PvpStartRequest, PvpStartResponse>(new PvpStartRequest()
                {
                    RivalPlayerRank = pvpRankingPlayerInfo.CurrentRank,
                    RivalPlayerId = pvpRankingPlayerInfo.PlayerInfo.PlayerId
                });

                pvpStartResponse.BattleRewardResult.FixedItemList.PrintUserItems(log);
                pvpStartResponse.BattleRewardResult.DropItemList.PrintUserItems(log);
            }
        });
    }

    private async Task BountyQuestRewardAuto()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            log("领取的奖励：\n");
            var getListResponse = await moriFuncs.GetResponse<GetListRequest, GetListResponse>(
                new GetListRequest());

            var questIds = getListResponse.UserBountyQuestDtoInfos
                .Where(d => d.BountyQuestEndTime > 0)
                .Select(d => d.BountyQuestId).ToList();

            if (questIds.Count > 0)
            {
                var rewardResponse = await moriFuncs.GetResponse<RewardRequest, RewardResponse>(new RewardRequest() {BountyQuestIds = questIds, IsQuick = false});
                rewardResponse.RewardItems.PrintUserItems(log);
            }
        });
    }

    private async Task BountyQuestStartAuto()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            log("还未实现");
        });
    }

    private async Task AutoEquipmentInheritance()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            await moriFuncs.AutoEquipmentInheritance();
    // var msg = new StringBuilder("角色列表：\n");
    //
    // foreach (var userCharacterDtoInfo in _userSyncData.UserCharacterDtoInfos)
    // {
    //     var characterMb = Masters.CharacterTable.GetById(userCharacterDtoInfo.CharacterId);
    //     var name = Masters.TextResourceTable.Get(characterMb.NameKey);
    //     msg.AppendLine($"名称：{name} 等级： {userCharacterDtoInfo.Level} 稀有度：{characterMb.RarityFlags}");
    // }
            log("完成");
        });
    }

    private async Task BossHishSpeedBattle()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            log("领取的奖励：\n");

            var req = new QuickRequest() {QuestQuickExecuteType = QuestQuickExecuteType.Currency, QuickCount = 1};
            var quickResponse = await moriFuncs.GetResponse<QuickRequest, QuickResponse>(req);

            log($"金币 {quickResponse.AutoBattleRewardResult.GoldByPopulation}");
            log($"潜能宝珠 {quickResponse.AutoBattleRewardResult.PotentialJewelByPopulation}");
            log($"角色经验 {quickResponse.AutoBattleRewardResult.BattleRewardResult.CharacterExp}");
            log($"额外金币 {quickResponse.AutoBattleRewardResult.BattleRewardResult.ExtraGold}");
            log($"用户经验 {quickResponse.AutoBattleRewardResult.BattleRewardResult.PlayerExp}");
            log($"升级 {quickResponse.AutoBattleRewardResult.BattleRewardResult.RankUp}");

            quickResponse.AutoBattleRewardResult.BattleRewardResult.FixedItemList.PrintUserItems(log);
            quickResponse.AutoBattleRewardResult.BattleRewardResult.DropItemList.PrintUserItems(log);
        });
    }

    private async Task AutoDungeonBattle()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            await moriFuncs.AutoDungeonBattle(log);
            log("完成");
        });
    }

    private async Task Debug()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var giveAllSrCharacterResponse = await moriFuncs.GetResponse<NextQuestRequest, NextQuestResponse>(new NextQuestRequest());
            log(giveAllSrCharacterResponse.ToJson(true));
        });
    }
    private async Task LogDebug()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var counter = 0;
            while (!token.IsCancellationRequested)
            {
                log($"Message {counter++}");
                await Task.Delay(TimeSpan.FromMilliseconds(500), token);
            }
        });
    }
    private async Task UseFriendCode()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var useFriendCodeResponse = await moriFuncs.GetResponse<UseFriendCodeRequest, UseFriendCodeResponse>(new UseFriendCodeRequest(){FriendCode = ""});
        });
    }

    private async Task FreeGacha()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            log("每日免费五次 R 装备抽卡");
            var response1 = await moriFuncs.GetResponse<DrawRequest, DrawResponse>(new DrawRequest(){GachaButtonId = 18});
            response1.GachaRewardItemList.PrintUserItems(log);
            response1.BonusRewardItemList.PrintUserItems(log);
            log("每日免费一次圣遗物抽卡");
            var response2 = await moriFuncs.GetResponse<DrawRequest, DrawResponse>(new DrawRequest(){GachaButtonId = 37});
            response2.GachaRewardItemList.PrintUserItems(log);
            response2.BonusRewardItemList.PrintUserItems(log);
            log("每日免费一次魔水晶抽卡");
            var response3 = await moriFuncs.GetResponse<DrawRequest, DrawResponse>(new DrawRequest(){GachaButtonId = 41});
            response3.GachaRewardItemList.PrintUserItems(log);
            response3.BonusRewardItemList.PrintUserItems(log);
        });
    }

    private async Task GuildCheckin()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var response1 = await moriFuncs.GetResponse<GetGuildIdRequest, GetGuildIdResponse>(new GetGuildIdRequest());
            log($"公会 Id {response1.GuildId}");
            var response2 = await moriFuncs.GetResponse<GetGuildBaseInfoRequest, GetGuildBaseInfoResponse>(new GetGuildBaseInfoRequest(){BelongGuildId = response1.GuildId});
            log("签到成功");
            response2.UserSyncData.GivenItemCountInfoList.PrintUserItems(log);
        });
    }

    private async Task GuildRaid()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            var response1 = await moriFuncs.GetResponse<GetGuildIdRequest, GetGuildIdResponse>(new GetGuildIdRequest());
            log($"公会 Id {response1.GuildId}");
            while (true)
            {
                var response2 = await moriFuncs.GetResponse<GetGuildRaidInfoRequest, GetGuildRaidInfoResponse>(new GetGuildRaidInfoRequest(){BelongGuildId = response1.GuildId});
                if (response2.GuildRaidInfos.All(d=>!d.IsOpen || d.UserGuildRaidDtoInfo is {ChallengeCount: >= 2 }))
                {
                    log("没有可扫荡的讨伐战");
                    break;
                }
                foreach (var info in response2.GuildRaidInfos)
                {
                    if (info.IsOpen && (info.UserGuildRaidDtoInfo == null || info.UserGuildRaidDtoInfo is {ChallengeCount: < 2 }))
                    {
                        var response3 = await moriFuncs.GetResponse<QuickStartGuildRaidRequest, QuickStartGuildRaidResponse>(new QuickStartGuildRaidRequest(){BelongGuildId = response1.GuildId, GuildRaidBossType = info.GuildRaidDtoInfo.BossType});
                        log($"战斗结果: {response3.BattleSimulationResult.BattleEndInfo.IsWinAttacker()}");
                        log("固定掉落");
                        response3.BattleRewardResult.FixedItemList.PrintUserItems(log);
                        log("随机掉落");
                        response3.BattleRewardResult.DropItemList.PrintUserItems(log);
                    }
                }
            }
        });
    }

    private async Task AutoBossRequest()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            int totalCount = 0;
            int winCount = 0;
            int errCount = 0;
            while (!token.IsCancellationRequested)
            {
                try
                {
                    await moriFuncs.UserGetUserData();
                    var bossResponse = await moriFuncs.GetResponse<BossRequest, BossResponse>(new BossRequest() {QuestId = _userSyncData.UserBattleBossDtoInfo.BossClearMaxQuestId + 1});
                    var win = bossResponse.BattleResult.SimulationResult.BattleEndInfo.IsWinAttacker();
                    totalCount++;
                    if (win)
                    {
                        var nextQuestResponse = await moriFuncs.GetResponse<NextQuestRequest, NextQuestResponse>(new NextQuestRequest());
                        winCount++;
                    }
                    var m = $"挑战 boss 一次：{win} 总次数：{totalCount} 胜利次数：{winCount}, Err: {errCount}";
                    Console.WriteLine(m);
                    log(m);
                    StateHasChanged();
                    var t = 1;
                    await Task.Delay(t);
                }
                catch (Exception e)
                {
                    errCount++;
                    if (errCount > 10)
                    {
                        return;
                    }
                    while (true)
                    {
                        try
                        {
                            await moriFuncs.AuthLogin();
                            break;
                        }
                        catch (Exception)
                        {
                            await Task.Delay(1000);
                        }
                    }
                }
            }
        });
    }

    private async Task AutoInfiniteTowerRequest()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            int totalCount = 0;
            int winCount = 0;
            int errCount = 0;
            while (!token.IsCancellationRequested)
            {
                try
                {
                    await moriFuncs.UserGetUserData();
                    var tower = _userSyncData.UserTowerBattleDtoInfos.First(d => d.TowerType == TowerType.Infinite);
                    var bossQuickResponse = await moriFuncs.GetResponse<StartRequest, StartResponse>(
                        new StartRequest()
                        {
                            TargetTowerType = TowerType.Infinite, TowerBattleQuestId = tower.MaxTowerBattleId + 1
                        });
                    var win = bossQuickResponse.BattleResult.SimulationResult.BattleEndInfo.IsWinAttacker();
                    totalCount++;
                    if (win)
                    {
                        winCount++;
                    }
                    var m = $"挑战无穷之塔一次：{win} 总次数：{totalCount} 胜利次数：{winCount}, Err: {errCount}";
                    Console.WriteLine(m);
                    log(m);
                    StateHasChanged();
                    var t = 1;
                    await Task.Delay(t);
                }
                catch (Exception e)
                {
                    errCount++;
                    if (errCount > 10)
                    {
                        return;
                    }
                    while (true)
                    {
                        try
                        {
                            await moriFuncs.AuthLogin();
                            break;
                        }
                        catch (Exception)
                        {
                            await Task.Delay(1000);
                        }
                    }
                }
            }
        });
    }

    private async Task AutoEquipmentTraning()
    {
        await ExecuteQuickAction(async (log, token) =>
        {
            int totalCount = 0;
            int winCount = 0;
            while (!token.IsCancellationRequested)
            {
                var equipment = _userSyncData.UserEquipmentDtoInfos.First(d => d.Guid == _equipmentId);
                switch (_equipmentTrainingTargetType)
                {
                    case "Health" when equipment.AdditionalParameterHealth >= _equipmentTrainingTargetValue:
                        return;
                    case "Energy" when equipment.AdditionalParameterEnergy >= _equipmentTrainingTargetValue:
                        return;
                    case "Intelligence" when equipment.AdditionalParameterIntelligence >= _equipmentTrainingTargetValue:
                        return;
                    case "Muscle" when equipment.AdditionalParameterMuscle >= _equipmentTrainingTargetValue:
                        return;
                }
                await moriFuncs.UserGetUserData();
                var response = await moriFuncs.GetResponse<TrainingRequest, TrainingResponse>(new TrainingRequest() {EquipmentGuid = _equipmentId, ParameterLockedList = new List<BaseParameterType>()});
                await moriFuncs.UserGetUserData();
                var m = $"打磨装备 耐力 {equipment.AdditionalParameterEnergy} 魔力 {equipment.AdditionalParameterIntelligence} 力量 {equipment.AdditionalParameterMuscle} 战技 {equipment.AdditionalParameterEnergy}";
                Console.WriteLine(m);
                log(m);
                StateHasChanged();
                var t = 1;
                await Task.Delay(t);
            }
        });
    }

}